<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project CrisisTruth - Real-Time Crisis Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(to right, #1e3a8a, #3b82f6);
        }
        /* Modal styles */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="gradient-bg shadow-md sticky top-0 z-50">
        <!-- ... existing header code ... -->
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <h1 class="text-2xl font-bold text-white ml-2">CrisisTruth</h1>
                </div>
                <div class="text-sm text-white font-medium">
                    <span class="hidden sm:inline">Live from MumbaiHacks 2025</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Status Banner -->
        <div class="mb-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-sm" role="alert">
            <p class="font-bold">Active Event: Mumbai Cyclone Watch</p>
            <p>We are actively monitoring information related to the developing cyclone situation. Stay tuned for verified updates.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Live Alerts & Interactive AI Tools -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">Live Verified Alerts</h2>
                    <div id="alerts-container" class="space-y-4">
                        <!-- Alerts will be dynamically inserted here -->
                    </div>
                </div>
                
                <!-- Interactive AI Tools Section -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Gemini Ask Section -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 flex items-center">
                            <span class="text-yellow-500 mr-2">✨</span> Ask CrisisTruth
                        </h2>
                        <p class="text-gray-600 mb-4 text-sm">Have a question? Our AI assistant can provide a grounded, up-to-date answer.</p>
                        <div id="ask-gemini-form" class="space-y-3">
                            <input type="text" id="user-question" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Which roads are closed?">
                            <button id="ask-button" class="w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity">
                                Get Verified Answer
                            </button>
                        </div>
                        <div id="gemini-answer-container" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200" style="display: none;">
                            <!-- Gemini's answer will appear here -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- Right Column: Stats & Trends -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <!-- ... existing right column code ... -->
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Information Trends</h2>
                <div class="text-center">
                    <p class="text-lg font-medium text-gray-600 mb-2">Misinformation vs. Verified Reports</p>
                    <div id="info-chart" class="w-full h-64"></div>
                    <div class="mt-4 flex justify-around text-sm">
                        <div class="flex items-center">
                            <span class="h-3 w-3 rounded-full bg-red-500 mr-2"></span> Misinformation
                        </div>
                        <div class="flex items-center">
                            <span class="h-3 w-3 rounded-full bg-blue-500 mr-2"></span> Verified
                        </div>
                    </div>
                </div>
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-lg font-semibold mb-2">Key Stats</h3>
                    <div class="space-y-2 text-gray-700">
                        <div class="flex justify-between"><span>Claims Analyzed:</span> <span class="font-bold" id="claims-analyzed">0</span></div>
                        <div class="flex justify-between"><span>Misinformation Flagged:</span> <span class="font-bold text-red-600" id="misinfo-flagged">0</span></div>
                        <div class="flex justify-between"><span>Sources Monitored:</span> <span class="font-bold">15+</span></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Gemini Modal -->
    <div id="gemini-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 modal-backdrop hidden">
        <!-- ... existing modal code ... -->
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 modal-content scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">✨ AI Generated Content</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modal-body" class="text-gray-700">
                <div class="flex justify-center items-center h-32">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Mock Data & Simulation ---
        // ... existing mock data code ...
        const mockAlerts = [
            { 
                id: 1,
                claim: "Mumbai's Bandra-Worli Sea Link has collapsed due to high winds!",
                status: "false", 
                truth: "Authorities have confirmed the Bandra-Worli Sea Link is structurally sound and has been temporarily closed to traffic as a precaution. Images circulating are from a different event years ago.",
                timestamp: "2 mins ago",
                source: "Social Media"
            },
            {
                id: 2,
                claim: "Cyclone has been upgraded to Category 4.",
                status: "unverified",
                truth: "We are currently verifying this claim with the India Meteorological Department (IMD). Official reports still classify it as Category 3. Awaiting confirmation.",
                timestamp: "5 mins ago",
                source: "Messaging Apps"
            },
            {
                id: 3,
                claim: "Evacuation centers are being set up in schools in Colaba.",
                status: "true",
                truth: "The BMC has confirmed that 5 schools in the Colaba region are now open as official evacuation centers. A list of addresses is available on the official BMC website.",
                timestamp: "15 mins ago",
                source: "Official BMC Channel"
            }
        ];
        let claimsAnalyzed = 128;
        let misinfoFlagged = 34;

        // --- Gemini API Integration ---
        const API_KEY = "AIzaSyAh2-zBZpOdM2U-E1YPx6HUz0Iv-v1PVqk"; // Your new API Key
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        const loadingSpinner = `<div class="flex justify-center items-center h-full"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div></div>`;
        
        async function callTextAPI(prompt, isGrounded = false, systemInstruction = null) {
            // ... existing text API call function ...
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            if (isGrounded) {
                payload.tools = [{ "google_search": {} }];
            }
            if (systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            let responseText = "Sorry, I couldn't get a response. Please try again.";
            try {
                let response;
                let delay = 5000; // Increased initial delay
                for (let i = 0; i < 5; i++) { // Increased retries
                     response = await fetch(TEXT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    responseText = candidate.content.parts[0].text;
                }
            } catch (error) {
                console.error("Gemini Text API call failed:", error);
            }
            return responseText.replace(/\n/g, '<br>'); // Format for HTML
        }

        // --- UI Rendering ---
        const alertsContainer = document.getElementById('alerts-container');
        
        function getStatusChip(status) {
            // ... existing function ...
            switch(status) {
                case 'true':
                    return `<div class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">VERIFIED TRUE</div>`;
                case 'false':
                    return `<div class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">FALSE</div>`;
                case 'unverified':
                    return `<div class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">UNVERIFIED</div>`;
            }
        }

        function renderAlert(alert) {
            // ... existing function ...
            const alertEl = document.createElement('div');
            alertEl.className = `p-4 rounded-lg border-l-4 ${alert.status === 'false' ? 'border-red-500 bg-red-50' : alert.status === 'true' ? 'border-green-500 bg-green-50' : 'border-yellow-500 bg-yellow-50'}`;
            
            let geminiButtons = `<button data-action="summarize" data-content="${alert.truth}" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-md hover:bg-blue-200">✨ Simple Summary</button>`;
            if (alert.status === 'true') {
                geminiButtons += `<button data-action="safety-tips" data-content="${alert.truth}" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-md hover:bg-green-200 ml-2">✨ Get Safety Tips</button>`;
            }

            alertEl.innerHTML = `
                <div class="flex items-center mb-2">
                    ${getStatusChip(alert.status)}
                    <span class="text-xs text-gray-500">${alert.timestamp} via ${alert.source}</span>
                </div>
                <p class="font-semibold text-gray-700 mb-1">Claim: "${alert.claim}"</p>
                <p class="text-gray-900">${alert.truth}</p>
                <div class="mt-3 flex items-center space-x-2">
                    ${geminiButtons}
                </div>
            `;
            alertsContainer.prepend(alertEl);
        }

        // --- Chart Rendering (D3.js) ---
        function renderChart() {
            // ... existing function ...
            const data = [ {label: "Misinformation", value: misinfoFlagged}, {label: "Verified", value: claimsAnalyzed - misinfoFlagged} ];
            const chartContainer = document.getElementById('info-chart');
            chartContainer.innerHTML = '';
            const width = chartContainer.clientWidth;
            const height = chartContainer.clientHeight;
            const radius = Math.min(width, height) / 2;
            const svg = d3.select("#info-chart").append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${width / 2}, ${height / 2})`);
            const color = d3.scaleOrdinal().domain(data.map(d => d.label)).range(["#ef4444", "#3b82f6"]);
            const pie = d3.pie().value(d => d.value).sort(null);
            const data_ready = pie(data);
            const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.8);
            svg.selectAll('path').data(data_ready).join('path').attr('d', arc).attr('fill', d => color(d.data.label)).attr("stroke", "white").style("stroke-width", "2px");
            svg.append("text").attr("text-anchor", "middle").attr("dy", "0.35em").text(`${((misinfoFlagged / claimsAnalyzed) * 100).toFixed(0)}%`).style("font-size", "24px").style("font-weight", "bold");
        }

        // --- Modal & Text Gemini Logic ---
        const modal = document.getElementById('gemini-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        function showModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal-backdrop').classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function hideModal() {
            modal.querySelector('.modal-backdrop').classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        closeModalBtn.addEventListener('click', hideModal);

        alertsContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const content = button.dataset.content;
            showModal();
            modalBody.innerHTML = loadingSpinner;
            let prompt, title;
            if (action === 'summarize') {
                title = '✨ Simple Summary';
                prompt = `Summarize the following text into a single, simple sentence that is easy to understand during a stressful situation: "${content}"`;
            } else if (action === 'safety-tips') {
                title = '✨ Actionable Safety Tips';
                prompt = `Based on the fact that "${content}" during a cyclone in Mumbai, generate 3-4 concise, actionable safety tips as a bulleted list. The tips should be clear and easy to follow in an emergency.`;
            }
            modalTitle.textContent = title;
            const result = await callTextAPI(prompt);
            modalBody.innerHTML = result;
        });

        // --- "Ask CrisisTruth" Logic ---
        const askButton = document.getElementById('ask-button');
        const userQuestionInput = document.getElementById('user-question');
        const geminiAnswerContainer = document.getElementById('gemini-answer-container');
        askButton.addEventListener('click', async () => {
            const question = userQuestionInput.value;
            if (!question.trim()) return;
            geminiAnswerContainer.style.display = 'block';
            geminiAnswerContainer.innerHTML = loadingSpinner;
            askButton.disabled = true;
            askButton.textContent = 'Getting Answer...';
            const systemInstruction = "You are an AI assistant for CrisisTruth, a platform providing verified information during the Mumbai Cyclone. Your goal is to answer user questions factually and calmly, based on search results. Do not speculate. If you don't know, say that you are unable to find verified information. Keep the answer concise and clear.";
            const result = await callTextAPI(question, true, systemInstruction);
            geminiAnswerContainer.innerHTML = result;
            askButton.disabled = false;
            askButton.textContent = 'Get Verified Answer';
        });

        // --- Initial Load & Dynamic Updates ---
        window.onload = () => {
            // ... existing onload code ...
            document.getElementById('claims-analyzed').textContent = claimsAnalyzed;
            document.getElementById('misinfo-flagged').textContent = misinfoFlagged;
            mockAlerts.forEach(renderAlert);
            renderChart();
            setInterval(() => {
                claimsAnalyzed += Math.floor(Math.random() * 5) + 1;
                misinfoFlagged += Math.random() > 0.7 ? 1 : 0;
                document.getElementById('claims-analyzed').textContent = claimsAnalyzed;
                document.getElementById('misinfo-flagged').textContent = misinfoFlagged;
                const newAlert = { id: mockAlerts.length + 1, claim: "New unverified claim about bridge safety appears online.", status: "unverified", truth: "Our systems have detected a new claim and are currently working to verify it against official sources.", timestamp: "Just now", source: "Social Media" };
                renderAlert(newAlert);
                renderChart();
            }, 8000);
        };
        
        window.onresize = renderChart;
    </script>
</body>
</html>

